<!DOCTYPE html>

<!--suppress HtmlDeprecatedAttribute -->
<head>
    <meta charset="utf-8">
    <title>Residual BB power from polarisation angle calibration (CV)</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <!-- Load up MathJax for math notation -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
              tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
    </script>
    <script type="text/javascript"
            src="../mathjax/MathJax.js?config=TeX-AMS-MML_SVG">
            // src="../mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

</head>

<body>
<!-- Add my custom pager script -->
<script type="text/javascript" src="scripts/pager.js"></script>
<link rel="stylesheet" type="text/css" href="scripts/pager.css">

<header>
    <h1>Bias on r from polarisation angles</h1>

    <time datetime="2023-11-07" class="published updated">
        2023 Dec 11
    </time> —
    Clara Vergès
</header>

<hr>

This posting looks into BB signals generated by instrumental polarisation, and how they may affect our capacity 
to constrain $r$.

<section><h2>Context</h2>
<p>
    In our standard CMB analysis pipeline, we don't use individual measurements of detector polarisation
    angles to make maps. Instead we use design angles (with an overall adjustement coming from CMB pointing), which 
    introduces an apparent miscalibration of the instrument polarisation angle. The biggest manifestation of that effect is the generation of EB/TB signals of instrumental 
    origin. It also generates a fake BB signal, which is a source of systematic contamination for constraining $r$.
    <br><br>
    We correct for that effect by fitting an overall polarisation angle to the maps, that nulls the EB/TB spectra. 
    This process is typically refered to as self-calibration, EB-nullling or calibration off the E-modes.
    While it does correctly calibrate the overall polarisation angle of the instrument, it does not take into 
    account detector-to-detector variation in polarisation angles, and leaves some level of residual BB signal.
    <br><br>
    We have evidence from the BICEP3 RPS measurements that the distribution of angles in roughly Gaussian with 
    a standard deviation of $\sim 0.5^{\circ}$. However, these angles are not distributed randomly over the focal plane,
    as we have identified per-tile trends that correlate well with the tile orientation 
    that we can extract from CMB analysis.
    The goal of this posting is to evaluate the performance of the overall derotation procedure on simulations that contain different level of 
    complexity in the angle distrubution, from no detector-to-detector variation to the measured angles.  
    Ultimately, we want to know if this could have an impact on $r$ constraints.
</p>
</section>

<section><h2> Analysis approaches </h2>

<p>

    The analysis approach describes how polarisation angles are incorporated in the analysis - for both
    sims and real data.
    <ul>
        <li>
            <b>Uncalibrated</b> maps correspond to the "raw" state of the data. That's how our initial real maps are processed: 
            data (TODs) is acquired with the real instrument angles, but we make maps using ideal values adjusted for the CMB
            pointing. These angles are called "Obs" in the standard pipeline nomenclature.
            Because of the difference between "Obs" and real angles, the resulting maps have non-zero EB/TB spectra that can be 
            interpreted as an overall, effective rotation angle. 
        </li>
        <li>
            <b>Uncalibrated derotated</b> maps are made by correcting the uncalibrated maps for this overall, effective rotation angle.
            This angle is simply fit by nulling the EB/TB spectra, and then all maps are derotated by that amount.
            The maps we used for all the standard $r$ analysis undergo this procedure before moving to the multi-component 
            analysis. 
        </li>
        <li> <b>Calibrated</b> maps can only be produced if we have measurements of the detector polarisation angles.
            In that case, we can do map-making using each individual pair real angle, and the derotation procedure 
            becomes unecassary.
        </li>
    </ul>

    If all detectors in the focal plane had the same angle, but different from the design angle, and all pairs contributed to the maps in the 
    same way, the "uncalibrated derotated" and "calibrated" approach would be identical.
    In reality, we know that there are variations within tile, and we also have ecidence for tile-to-tile 
    offsets due to the physical clocking of tiles on the focal plane.
    Due do that effect, when we apply an overall angle to the uncalibrated maps to derotate them, there are 
    second order effects in the polarisation angle variations of individual detectors that are not corrected for.
</p>

<section><h2>Results for different configurations</h2>

<p> Note that all sims in this posting are single year (B2018), type 2 sims (Unlensed CMB), which means 
    that in principle we expect zero BB power
</p>

<h3>Global offset angle</h3>
<p>
    The first thing I am checking here is if the simulation pipeline gives the right BB power 
    scaling as a function of input angle. The level of BB power generated as a function of 
    the instrument angle $\alpha$ is 
    \begin{equation}
    \mathcal{C}_{\ell}^{BB}(\alpha) =  \mathcal{C}_{\ell}^{EE} \sin^2(2 \alpha) +  \mathcal{C}_{\ell}^{BB}  \cos^2(2 \alpha) 
    \end{equation}

    For a given sky realisation and in the small angle limit, we can therefore expect that the 
    BB power will scale as $\alpha^2$

    <br><br>

    Figure 3.1 shows sims that have a global rotation angle applied with no derotation 
    (uncalibrated approach). As a reminder, $\rho$ values are a simple metric for the amount of 
    B-mode contamination scaled from a fiducial $r$ value.
</p>


<figure>
    <img alt="glob_off" id="glob_off" src="#glob_off" width="70%" onerror=this.src="" />
    <figcaption>
      BB aps & rho estimator
    <script type="text/javascript">
        var globpager = new Pager("glob_off");
        globpager.link("#glob_off",
            { 'Global offset angle|simset': ['0deg|6600','+0.25deg|6612','+0.5deg|6610','+1deg|6613','+2deg|6634','+4deg|6636'],
             'Plot|plot_type': ['aps|aps','rho|rho'],
             'Subtract purificatio residual|debias': ['yes|_debiased','no|'],
             'Axis|axis':['free|_free','fixed|'],
            },
            function(params) {
                return 'figs/' + params.plot_type + '_' + params.simset + '_type2' + params.axis + params.debias + '.png';
            });
        globpager.setparams({
            'simset': '6612',
            'plot_type': 'aps',
            'debias':'',
            'axis':'',
        });
    </script>
</figure>

<p> 
    Figure 3.2 shows how $\rho$ scales with $\alpha$.
    One thing to note here is that for low values of $\alpha$ (below 1deg), the results
    deviate from the quadratic scaling as we are intrinsically limited by residual BB power 
    coming from the performance of the purification matrix.
    I choose to treat this limitation as an algorithmic floor, and I have added an option 
    to subtract this purification residual. In that case, the residual BB power for no rotation angle ("0deg") is simply subtracted 
    from the BB power for other cases, realisation-by-realisation.
    When doing that, one correctly recovers a quadratic scaling even for low values of $\alpha$.
</p>

<figure>
    <img alt="rho_alpha" id="rho_alpha" src="#rho_alpha" width="70%" onerror=this.src="" />
    <figcaption>
      rho vs. alpha
    <script type="text/javascript">
        var globpager = new Pager("rho_alpha");
        globpager.link("#rho_alpha",
            { 'Subtract purification residual|debias': ['yes|_debiased','no|'],
            },
            function(params) {
                return 'figs/rho_vs_alpha' + params.debias + '.png';
            });
        globpager.setparams({
            'debias':'',
        });
    </script>
</figure>

<h3>Angle variation accross the focal plane</h3>

  <p>
  The angles measured in the RPS campaign have a mean of $\sim -0.75^{\circ}$ with a standard deviation 
  of $\sim 0.5 ^{\circ}$, with clearly identified per-tile trends.
  All sims below use a subset of B3's detectors, corresponding to detectors for which we have RPS measurements,
  so that the different cases can be directly compared to each other. 
  I am showing here 4 scenarios for input angles going from the most simple one to the real one:
   <ul>
    <li>
       Overall rotation angle of -0.75deg applied uniformly to all detectors;
      </li>
    <li>
       Gaussian distribution of angles that have the same mean ($-0.75^{\circ}$) and standard deviation
       ($0.5^{\circ}$) as the measured angles, and are randomly distributed over the focal plane;
    </li>
    <li>
        Each tile gets a different rotation angle that matches the RPS measurement, with no variations 
        within the tile.
    </li>
    <li>
        RPS measured angles as derived from the 2022 calibration campaign and used in the isotropic
        polarisation rotation analysis. 
    </li>
    <!-- <li> 
        Finally, an option using only half the detectors (RPS half split) where the detectors are chosen so that 
        their mean angle and standard deviation are similar to global distribution of all polarisation angles.
    </li> -->
</ul>

  </p>
  <figure>
    <img alt="rpsangles" id="rpsangles" src="#rpsangles" width="70%" onerror=this.src="" />
    <figcaption>
      BB aps & rho estimator
    <script type="text/javascript">
        var rpspager = new Pager("rpsangles");
        rpspager.link("#rpsangles",
            { 'Angles|angles': ['RPS measured|meas', 'Gaussian distribution|gauss', 'Overall angle|overall', 'Per-tile offsets|tile'],
             'Analysis approach|app': ['Uncalibrated|uncal','Uncalibrated derotated|uncal_derot','Calibrated|cal'],
             'Plot|plot_type': ['aps|aps','rho|rho'],
             'Subtract purification residual|debias': ['yes|_debiased','no|'],
             'Axis|axis':['free|_free','fixed|'],
            },
            function(params) {
                  if (params.angles == 'meas')
                    if (params.app == 'uncal')
                        {return 'figs/'+params.plot_type +'_6644_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'uncal_derot')
                        {return  'figs/'+params.plot_type +'_6645_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'cal')
                        {return  'figs/'+params.plot_type +'_6621_type2' + params.axis + params.debias + '.png';
                        }
                    else
                        {return}
                  else if (params.angles == 'gauss')
                    if (params.app == 'uncal')
                        {return 'figs/'+params.plot_type +'_6630_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'uncal_derot')
                        {return  'figs/'+params.plot_type +'_6631_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'cal')
                        {return  'figs/'+params.plot_type +'_6633_type2' + params.axis + params.debias + '.png';
                        }
                    else
                        {return}
                  else if (params.angles == 'overall')
                    if (params.app == 'uncal')
                        {return 'figs/'+params.plot_type +'_6637_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'uncal_derot')
                        {return  'figs/'+params.plot_type +'_6639_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'cal')
                        {return  'figs/'+params.plot_type +'_6638_type2' + params.axis + params.debias + '.png';
                        }
                    else
                        {return}
                else if (params.angles == 'tile')
                    if (params.app == 'uncal')
                        {return 'figs/'+params.plot_type +'_6641_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'uncal_derot')
                        {return  'figs/'+params.plot_type +'_6642_type2' + params.axis + params.debias + '.png';
                        }
                    else if (params.app == 'cal')
                        {return  'figs/'+params.plot_type +'_6643_type2' + params.axis + params.debias + '.png';
                        }
                    else
                        {return}
                //  else if (params.angles == 'half')
                //     if (params.app == 'uncal')
                //         {return 'figs/'+params.plot_type +'_6646_type2' + params.axis + params.debias + '.png';
                //         }
                //     else if (params.app == 'uncal_derot')
                //         {return  'figs/'+params.plot_type +'_6647_type2' + params.axis + params.debias + '.png';
                //         }
                //     else if (params.app == 'cal')
                //         {return  'figs/'+params.plot_type +'_6621_type2' + params.axis + params.debias + '.png';
                //         }
                //     else
                //         {return}
              }
            );
        rpspager.setparams({
            'angles': 'meas',
            'app': 'uncal',
            'plot_type': 'aps',
            'debias':'',
            'axis':'',
        });
    </script>
</figure>

<p>
    I repeat the procedure to get rid of residual BB power coming from the matrix purification.
   All results discussed below are when this subtraction has been applied. <br><br>
   The first thing to note is that for all angle configurations, the option "Calibrated"
   makes the BB power go the 0, which confirms that the procedure works as expected.
   We can also note that for the "Overall angle" case, derotation and calibration perform the same, which again is 
   expected as there shouldn't be any residual BB power if only an overall rotation angle is applied. <br><br>

   <b> For the "RPS measured - Derotated" case, we get $\rho = 4 \times 10^{-5}$. 
   This value is representative of the performance our current derotation procedure, so this work confirms 
   that this is very low. </b> <br>
   It is somewhat interesting to note that the "Gaussian distribution - Derotated"
   case gives $\rho = 8 \times 10^{-5}$, which is higher.
   It is also interesting to note that the "per-tile" case matches very well results obtained for the RPS 
   distribution, which seems to indicate that we are dominated by per-tile offsets more than anything else.
</p>


<h3>Realistic configuration</h3>

<p> In this final section, I explore how we might end up using RPS 
    measured angles in reality. The "Calibrated" option from above is unrealistic,
    as we will never manage to measure individual polarisation angle with infinite precision 
    and accuracy. I therefore test an approach where I generate TODs with the RPS angles 
    as measured, and I make maps with similar angles, but with a slight offset.
    Angles assumed in mapmkaing are offset from the ones assumed when making TODs by a angle 
    drawn from a Gaussian distribution with $\mu = 0.1^{\circ}$ (corresponding to our systematic error)
    and $\sigma = 0.05^{\circ}$ (correspoding to our statistical uncertainty). <br><br>
    I have also tried to do something more realistic for subtracting the contribution of matrix purification,
    and used the mean of sims to debias (instead of a sim-by-sim subtracttion), which makes a small 
    difference on the standard deviation on the $\rho$ distribution.
</p>


<figure>
    <img alt="real" id="real" src="#real" width="70%" onerror=this.src="" />
    <figcaption>
      BB aps & rho estimator
    <script type="text/javascript">
        var rpspager = new Pager("real");
        rpspager.link("#real",
            { 'Analysis approach|app': ['Uncalibrated|6644','Uncalibrated derotated|6645','Calibrated|6621','Calibrated with offset|6649'],
             'Plot|plot_type': ['aps|aps','rho|rho'],
             'Subtract purification residual|debias': ['yes|_debiased','no|','use mean of sims|_debiased_mean'],
             'Axis|axis':['free|_free','fixed|'],
            },
            function(params) {
                return 'figs/'+ params.plot_type +'_' + params.app  + '_type2' + params.axis + params.debias + '.png';
            });
        rpspager.setparams({
            'app': '6644',
            'plot_type': 'aps',
            'debias':'',
            'axis':'',
        });
    </script>
</figure>

<p> The interesting clicks to compare here are "uncalibrated derotated" vs "calibrated with offset".
    It compares the performance of our current angle calibration aprocedure vs what we could achieve 
    if we used polarisation angles with the precision we think we can reach with the RPS.
    For now, it seems that we null out more BB power using the global derotation procedure, but the performance 
    with RPS measured angles would surely improve if we decrease the systematic and statistical uncertainties
    associated with the RPS measurement.
</p>

</section>  

<section><h2>Conclusion</h2>

    <p>In this posting, I have explored how residual BB power from polarisation angle calibration might 
        affect our ability to constrain $r$.
        The residual BB power is however dependant on polarisation angles layout on the focal plane,
        with the dominant effect coming from tile-to-tile variations.
        Even when we don't have polarisation angle measurement, we can take out most of this contribution 
        by fitting a global angle to our maps, which leaves us with very low residual BB power.
        Doing this seems to actually perform better compared to calibrating our maps with angles that would
        be slightly offset compared to real angles - assuming current RPS performance. <br><br>
        For BK level of sensitivity, the contamination remains very low - all numbers here are $\rho$
        values, not bias on $r$ which we would expect to bemuch smaller - but this gives us some insight on 
        what are the relevant parameters to approach this question in the context of more sensitive experiments.
    </p>

</section>

<hr>
<p>
    <b>References</b>
    <ul>
        <li> 
            <a href=http://bicep.rc.fas.harvard.edu/~bicep2/papers/2023_pol_rot/>
               IPR paper page </a> - see IPR posting series 
        </li>
        <li>
            <a href="http://bicep.rc.fas.harvard.edu/bkcmb/analysis_logbook/analysis/20160907_polrot/">
                Birefringence/Polarization rotation in K2015 and BK15
            </a>
        </li>
    </ul>
</p>

</body>


